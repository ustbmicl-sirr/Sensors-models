# ç³»ç»Ÿæ¶æ„å®Œæ•´æ–‡æ¡£

**å¤šæ™ºèƒ½ä½“å¼ºåŒ–å­¦ä¹ æ³Šä½åˆ†é…ç³»ç»Ÿ - æŠ€æœ¯æ¶æ„**

---

## ğŸ“‹ ç›®å½•

- [ç¬¬ä¸€éƒ¨åˆ†ï¼šæ•´ä½“æ¶æ„](#ç¬¬ä¸€éƒ¨åˆ†æ•´ä½“æ¶æ„)
- [ç¬¬äºŒéƒ¨åˆ†ï¼šæ ¸å¿ƒæ¨¡å—](#ç¬¬äºŒéƒ¨åˆ†æ ¸å¿ƒæ¨¡å—)
- [ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ•°æ®æµç¨‹](#ç¬¬ä¸‰éƒ¨åˆ†æ•°æ®æµç¨‹)
- [ç¬¬å››éƒ¨åˆ†ï¼šéƒ¨ç½²æ¶æ„](#ç¬¬å››éƒ¨åˆ†éƒ¨ç½²æ¶æ„)
- [ç¬¬äº”éƒ¨åˆ†ï¼šå¼€å‘æŒ‡å—](#ç¬¬äº”éƒ¨åˆ†å¼€å‘æŒ‡å—)

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šæ•´ä½“æ¶æ„

### 1.1 ç³»ç»Ÿå±‚æ¬¡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·æ¥å£å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Web UI   â”‚  â”‚ REST API â”‚  â”‚ CLI      â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡é€»è¾‘å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ä»»åŠ¡ç®¡ç†     â”‚  â”‚ ç®—æ³•è°ƒåº¦     â”‚  â”‚ ç»“æœç¼“å­˜     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è®­ç»ƒå¼•æ“å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ RLlibè®­ç»ƒ    â”‚  â”‚ ç¯å¢ƒç®¡ç†     â”‚  â”‚ æ¨¡å‹ç®¡ç†     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®æŒä¹…å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ£€æŸ¥ç‚¹å­˜å‚¨   â”‚  â”‚ æ—¥å¿—å­˜å‚¨     â”‚  â”‚ ç»“æœå­˜å‚¨     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 é¡¹ç›®ç›®å½•ç»“æ„

```
MARL-task/
â”œâ”€â”€ ğŸ“ rllib_env/              # RLlibç¯å¢ƒå®ç°
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ berth_allocation_env.py
â”‚   â””â”€â”€ test_env.py
â”‚
â”œâ”€â”€ ğŸ“ environment/            # åŸºç¡€ç¯å¢ƒæ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ berth_env.py          # Gymnasiumç¯å¢ƒ
â”‚   â”œâ”€â”€ vessel.py             # èˆ¹èˆ¶ç±»å’Œç”Ÿæˆå™¨
â”‚   â””â”€â”€ shore_power.py        # å²¸ç”µç®¡ç†
â”‚
â”œâ”€â”€ ğŸ“ rewards/                # å¥–åŠ±å‡½æ•°æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ reward_calculator.py
â”‚
â”œâ”€â”€ ğŸ“ backend/                # FastAPIåç«¯
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ app.py                # ä¸»åº”ç”¨
â”‚   â”œâ”€â”€ api/                  # APIç«¯ç‚¹
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ task.py
â”‚   â”‚   â”œâ”€â”€ algorithm.py
â”‚   â”‚   â””â”€â”€ websocket.py
â”‚   â”œâ”€â”€ services/             # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ task_manager.py
â”‚   â”‚   â”œâ”€â”€ algorithm_runner.py
â”‚   â”‚   â””â”€â”€ result_cache.py
â”‚   â”œâ”€â”€ models/               # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ request.py
â”‚   â”‚   â””â”€â”€ response.py
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ logger.py
â”‚
â”œâ”€â”€ ğŸ“ frontend/               # Webå‰ç«¯
â”‚   â””â”€â”€ static/
â”‚       â”œâ”€â”€ index.html
â”‚       â”œâ”€â”€ css/
â”‚       â”œâ”€â”€ js/
â”‚       â””â”€â”€ assets/
â”‚
â”œâ”€â”€ ğŸ“ config/                 # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ default_config.yaml
â”‚   â””â”€â”€ logging_config.yaml
â”‚
â”œâ”€â”€ ğŸ“ data/                   # æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ real_world/
â”‚   â””â”€â”€ synthetic/
â”‚
â”œâ”€â”€ ğŸ“ results/                # ç»“æœç›®å½•
â”‚   â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ logs/
â”‚   â””â”€â”€ figures/
â”‚
â”œâ”€â”€ ğŸ“ ray_results/            # RLlibè®­ç»ƒç»“æœ
â”‚
â”œâ”€â”€ ğŸ“ docs/                   # æ–‡æ¡£
â”‚   â”œâ”€â”€ RLLIB_COMPLETE_GUIDE.md
â”‚   â”œâ”€â”€ ALGORITHM_DESIGN.md
â”‚   â””â”€â”€ SYSTEM_ARCHITECTURE.md
â”‚
â”œâ”€â”€ ğŸ“ archived/               # å½’æ¡£ä»£ç 
â”‚   â”œâ”€â”€ epymarl_backup_20251028/
â”‚   â””â”€â”€ matd3_backup_20251028/
â”‚
â”œâ”€â”€ ğŸ“„ rllib_train.py          # åŸºç¡€è®­ç»ƒè„šæœ¬
â”œâ”€â”€ ğŸ“„ rllib_train_advanced.py # é«˜çº§è®­ç»ƒè„šæœ¬
â”œâ”€â”€ ğŸ“„ requirements.txt        # Pythonä¾èµ–
â””â”€â”€ ğŸ“„ README.md              # é¡¹ç›®æ–‡æ¡£
```

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šæ ¸å¿ƒæ¨¡å—

### 2.1 ç¯å¢ƒæ¨¡å— (environment/)

**berth_env.py - Gymnasiumç¯å¢ƒ**:
```python
class BerthAllocationEnv(gym.Env):
    """æ³Šä½åˆ†é…Gymnasiumç¯å¢ƒ"""

    def __init__(self, config):
        # åˆå§‹åŒ–ç¯å¢ƒå‚æ•°
        self.num_vessels = config.get("num_vessels", 10)
        self.berth_length = config.get("berth_length", 2000.0)

        # å®šä¹‰ç©ºé—´
        self.observation_space = Box(...)
        self.action_space = Box(...)

        # åˆå§‹åŒ–çŠ¶æ€
        self.vessels = []
        self.current_time = 0
        self.allocated_vessels = []

    def reset(self, seed=None, options=None):
        """é‡ç½®ç¯å¢ƒ"""
        # ç”Ÿæˆèˆ¹èˆ¶
        self.vessels = self.vessel_generator.generate(self.num_vessels)

        # é‡ç½®çŠ¶æ€
        self.current_time = 0
        self.allocated_vessels = []

        return self._get_obs(), {}

    def step(self, action):
        """æ‰§è¡Œä¸€æ­¥"""
        # è§£æåŠ¨ä½œ
        position, waiting_time, shore_power_prob = self._parse_action(action)

        # æ‰§è¡Œåˆ†é…
        success = self._allocate_berth(position, waiting_time, shore_power_prob)

        # è®¡ç®—å¥–åŠ±
        reward = self.reward_calculator.calculate_reward(...)

        # æ›´æ–°çŠ¶æ€
        self._update_state()

        # æ£€æŸ¥ç»ˆæ­¢
        done = self._check_done()

        return self._get_obs(), reward, done, False, {}
```

**vessel.py - èˆ¹èˆ¶ç®¡ç†**:
```python
class Vessel:
    """èˆ¹èˆ¶æ•°æ®ç±»"""
    def __init__(self, vessel_id, length, arrival_time, priority, shore_power_capable):
        self.id = vessel_id
        self.length = length
        self.arrival_time = arrival_time
        self.priority = priority
        self.shore_power_capable = shore_power_capable

        # è¿è¡Œæ—¶çŠ¶æ€
        self.position = None
        self.waiting_time = 0
        self.berthing_time = None
        self.departure_time = None

class VesselGenerator:
    """èˆ¹èˆ¶ç”Ÿæˆå™¨"""
    def generate_realistic(self, num_vessels, horizon_days):
        """ç”ŸæˆçœŸå®èˆ¹èˆ¶åºåˆ—"""
        vessels = []
        # éé½æ¬¡æ³Šæ¾è¿‡ç¨‹
        for t in range(horizon_days * 24):
            rate = self._get_arrival_rate(t)
            num_arrivals = np.random.poisson(rate)
            for _ in range(num_arrivals):
                vessel = self._create_vessel(t)
                vessels.append(vessel)
        return vessels[:num_vessels]
```

**shore_power.py - å²¸ç”µç®¡ç†**:
```python
class ShorePowerManager:
    """å²¸ç”µç®¡ç†ç³»ç»Ÿ"""
    def __init__(self, num_segments=5):
        self.num_segments = num_segments
        self.capacities = [500] * num_segments
        self.loads = [0] * num_segments

    def allocate(self, vessel, position, shore_power_prob):
        """åˆ†é…å²¸ç”µ"""
        # ç¡®å®šå ç”¨æ®µ
        start_seg, end_seg = self._get_segments(position, vessel.length)

        # æ£€æŸ¥å®¹é‡
        for seg in range(start_seg, end_seg + 1):
            required = vessel.power_demand * shore_power_prob
            if self.loads[seg] + required > self.capacities[seg]:
                return False, 0

        # åˆ†é…æˆåŠŸ
        allocated_power = 0
        for seg in range(start_seg, end_seg + 1):
            power = vessel.power_demand * shore_power_prob
            self.loads[seg] += power
            allocated_power += power

        return True, allocated_power
```

### 2.2 RLlibç¯å¢ƒæ¨¡å— (rllib_env/)

**berth_allocation_env.py - MultiAgentEnv**:
```python
class BerthAllocationMultiAgentEnv(MultiAgentEnv):
    """RLlibå¤šæ™ºèƒ½ä½“ç¯å¢ƒåŒ…è£…"""

    def __init__(self, env_config):
        super().__init__()

        # åˆ›å»ºåŸºç¡€ç¯å¢ƒ
        from environment.berth_env import BerthAllocationEnv
        self.base_env = BerthAllocationEnv(env_config)

        # å®šä¹‰ç©ºé—´
        self.observation_space = self.base_env.observation_space
        self.action_space = self.base_env.action_space

        self._agent_ids = set()

    def reset(self, *, seed=None, options=None):
        """é‡ç½®ç¯å¢ƒ"""
        obs, info = self.base_env.reset(seed=seed)

        # ç”Ÿæˆæ™ºèƒ½ä½“ID
        self._agent_ids = {f"vessel_{i}" for i in range(self.base_env.num_vessels)}

        # å¤šæ™ºèƒ½ä½“è§‚æµ‹
        observations = {agent_id: obs for agent_id in self._agent_ids}
        infos = {agent_id: {} for agent_id in self._agent_ids}

        return observations, infos

    def step(self, action_dict):
        """æ‰§è¡Œä¸€æ­¥"""
        # èšåˆåŠ¨ä½œ
        actions = np.array(list(action_dict.values()))
        aggregated_action = np.mean(actions, axis=0)

        # æ‰§è¡Œ
        obs, reward, terminated, truncated, info = self.base_env.step(aggregated_action)

        # å¤šæ™ºèƒ½ä½“è¿”å›
        observations = {agent_id: obs for agent_id in self._agent_ids}
        rewards = {agent_id: reward for agent_id in self._agent_ids}
        terminateds = {agent_id: terminated for agent_id in self._agent_ids}
        truncateds = {agent_id: truncated for agent_id in self._agent_ids}
        infos = {agent_id: info for agent_id in self._agent_ids}

        # å…¨å±€ç»ˆæ­¢
        terminateds["__all__"] = terminated
        truncateds["__all__"] = truncated

        return observations, rewards, terminateds, truncateds, infos
```

### 2.3 å¥–åŠ±æ¨¡å— (rewards/)

**reward_calculator.py**:
```python
class RewardCalculator:
    """å¥–åŠ±è®¡ç®—å™¨"""

    def __init__(self, weights):
        self.weights = weights

    def calculate_reward(self, vessel, action, state):
        """è®¡ç®—å¥–åŠ±"""
        # åˆ†é¡¹è®¡ç®—
        r1 = self._base_reward(vessel)
        r2 = self._waiting_penalty(vessel)
        r3 = self._emission_penalty(vessel, action)
        r4 = self._shore_power_bonus(vessel, action)
        r5 = self._utilization_reward(state)
        r6 = self._spacing_reward(vessel, action, state)

        # åŠ æƒæ±‚å’Œ
        total = (
            self.weights['c1'] * r1
            - self.weights['c2'] * r2
            - self.weights['c3'] * r3
            + self.weights['c4'] * r4
            + self.weights['c5'] * r5
            + self.weights['c6'] * r6
        )

        return total
```

### 2.4 åç«¯æœåŠ¡æ¨¡å— (backend/)

**app.py - FastAPIä¸»åº”ç”¨**:
```python
from fastapi import FastAPI, WebSocket
from fastapi.staticfiles import StaticFiles

app = FastAPI(title="MARL Berth Allocation API")

# æŒ‚è½½é™æ€æ–‡ä»¶
app.mount("/static", StaticFiles(directory="frontend/static"), name="static")

# æ³¨å†Œè·¯ç”±
from api import task, algorithm, websocket
app.include_router(task.router, prefix="/api/tasks", tags=["tasks"])
app.include_router(algorithm.router, prefix="/api/algorithms", tags=["algorithms"])

@app.get("/")
def root():
    return {"message": "MARL Berth Allocation System API"}
```

**services/algorithm_runner.py**:
```python
class AlgorithmRunner:
    """ç®—æ³•è¿è¡Œå™¨"""

    def __init__(self):
        self.running_tasks = {}

    async def run_rllib_training(self, task_id, config):
        """è¿è¡ŒRLlibè®­ç»ƒ"""
        import ray
        from ray.rllib.algorithms.sac import SACConfig

        # åˆå§‹åŒ–Ray
        ray.init(ignore_reinit_error=True)

        # é…ç½®
        rllib_config = SACConfig()
        rllib_config.environment(env="berth_allocation", env_config=config)

        # è®­ç»ƒ
        algo = rllib_config.build()
        for i in range(config['num_iterations']):
            result = algo.train()

            # æ›´æ–°è¿›åº¦
            await self._update_progress(task_id, i, result)

        # ä¿å­˜æ¨¡å‹
        checkpoint = algo.save()

        algo.stop()
        ray.shutdown()

        return checkpoint
```

**services/task_manager.py**:
```python
class TaskManager:
    """ä»»åŠ¡ç®¡ç†å™¨"""

    def __init__(self):
        self.tasks = {}

    def create_task(self, task_config):
        """åˆ›å»ºä»»åŠ¡"""
        task_id = str(uuid.uuid4())

        task = {
            'id': task_id,
            'status': 'pending',
            'config': task_config,
            'created_at': datetime.now(),
            'progress': 0,
            'result': None,
        }

        self.tasks[task_id] = task
        return task_id

    def get_task(self, task_id):
        """è·å–ä»»åŠ¡"""
        return self.tasks.get(task_id)

    def update_task(self, task_id, updates):
        """æ›´æ–°ä»»åŠ¡"""
        if task_id in self.tasks:
            self.tasks[task_id].update(updates)
```

### 2.5 å‰ç«¯æ¨¡å— (frontend/)

**index.html - ä¸»é¡µé¢**:
```html
<!DOCTYPE html>
<html>
<head>
    <title>MARL Berth Allocation</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div id="app">
        <!-- å‚æ•°é…ç½®é¢æ¿ -->
        <div class="config-panel">
            <h2>é…ç½®å‚æ•°</h2>
            <input id="num-vessels" type="number" placeholder="èˆ¹èˆ¶æ•°é‡">
            <input id="planning-horizon" type="number" placeholder="è§„åˆ’å‘¨æœŸ(å¤©)">
            <button onclick="createTask()">ç”Ÿæˆä»»åŠ¡</button>
        </div>

        <!-- ç®—æ³•é€‰æ‹©é¢æ¿ -->
        <div class="algorithm-panel">
            <h2>é€‰æ‹©ç®—æ³•</h2>
            <select id="algorithm">
                <option value="SAC">SAC</option>
                <option value="PPO">PPO</option>
                <option value="Greedy">Greedy</option>
            </select>
            <button onclick="runAlgorithm()">è¿è¡Œç®—æ³•</button>
        </div>

        <!-- å¯è§†åŒ–é¢æ¿ -->
        <div class="visualization-panel">
            <canvas id="berth-canvas"></canvas>
            <div id="metrics"></div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
</body>
</html>
```

**app.js - å‰ç«¯é€»è¾‘**:
```javascript
// åˆ›å»ºä»»åŠ¡
async function createTask() {
    const numVessels = document.getElementById('num-vessels').value;
    const planningHorizon = document.getElementById('planning-horizon').value;

    const response = await fetch('/api/tasks', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            num_vessels: parseInt(numVessels),
            planning_horizon_days: parseInt(planningHorizon),
        })
    });

    const data = await response.json();
    window.currentTaskId = data.task_id;
    console.log('Task created:', data.task_id);
}

// è¿è¡Œç®—æ³•
async function runAlgorithm() {
    const algorithm = document.getElementById('algorithm').value;

    const response = await fetch('/api/algorithms/run', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            task_id: window.currentTaskId,
            algorithm: algorithm,
        })
    });

    const data = await response.json();
    console.log('Algorithm started:', data);

    // WebSocketç›‘å¬è¿›åº¦
    connectWebSocket(data.task_id);
}

// WebSocketè¿æ¥
function connectWebSocket(taskId) {
    const ws = new WebSocket(`ws://localhost:8000/ws/progress/${taskId}`);

    ws.onmessage = function(event) {
        const progress = JSON.parse(event.data);
        updateUI(progress);
    };
}
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ•°æ®æµç¨‹

### 3.1 è®­ç»ƒæ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥
   â†“
é…ç½®å‚æ•° {num_vessels, horizon, ...}
   â†“
ç”Ÿæˆèˆ¹èˆ¶åºåˆ— (VesselGenerator)
   â†“
åˆå§‹åŒ–ç¯å¢ƒ (BerthAllocationEnv)
   â†“
RLlibè®­ç»ƒå¾ªç¯:
   â”œâ”€ Workeré‡‡æ · â†’ ç¯å¢ƒäº¤äº’ â†’ æ”¶é›†æ ·æœ¬
   â”œâ”€ èšåˆæ ·æœ¬ â†’ Replay Buffer
   â”œâ”€ é‡‡æ ·Batch â†’ GPUè®­ç»ƒ â†’ æ›´æ–°ç­–ç•¥
   â””â”€ è¯„ä¼° â†’ è®°å½•æŒ‡æ ‡
   â†“
ä¿å­˜æ£€æŸ¥ç‚¹
   â†“
è¿”å›ç»“æœ {reward, metrics, checkpoint}
```

### 3.2 æ¨ç†æ•°æ®æµ

```
åŠ è½½æ£€æŸ¥ç‚¹ (Checkpoint)
   â†“
åˆå§‹åŒ–ç¯å¢ƒ
   â†“
è¾“å…¥èˆ¹èˆ¶æ•°æ®
   â†“
å¾ªç¯:
   â”œâ”€ è·å–è§‚æµ‹ (Observation)
   â”œâ”€ ç­–ç•¥æ¨ç† (Policy Inference)
   â”œâ”€ è¾“å‡ºåŠ¨ä½œ (Action)
   â””â”€ æ‰§è¡ŒåŠ¨ä½œ â†’ æ›´æ–°ç¯å¢ƒ
   â†“
è¾“å‡ºåˆ†é…æ–¹æ¡ˆ
   â†“
å¯è§†åŒ–ç»“æœ
```

### 3.3 APIè¯·æ±‚æµç¨‹

```
HTTPè¯·æ±‚ â†’ FastAPIè·¯ç”±
   â†“
è¯·æ±‚éªŒè¯ (Pydantic Model)
   â†“
ä¸šåŠ¡é€»è¾‘ (Service Layer)
   â”œâ”€ TaskManager: ä»»åŠ¡ç®¡ç†
   â”œâ”€ AlgorithmRunner: ç®—æ³•è¿è¡Œ
   â””â”€ ResultCache: ç»“æœç¼“å­˜
   â†“
æ•°æ®æŒä¹…åŒ–
   â”œâ”€ æ£€æŸ¥ç‚¹å­˜å‚¨
   â”œâ”€ æ—¥å¿—è®°å½•
   â””â”€ ç»“æœä¿å­˜
   â†“
HTTPå“åº” â†’ å‰ç«¯
   â†“
WebSocketå®æ—¶æ¨é€ (å¯é€‰)
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šéƒ¨ç½²æ¶æ„

### 4.1 æœ¬åœ°å¼€å‘éƒ¨ç½²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å¼€å‘æœºå™¨                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Pythonç¯å¢ƒ (Conda)      â”‚  â”‚
â”‚  â”‚  - ray[rllib]==2.50.1    â”‚  â”‚
â”‚  â”‚  - torch>=2.0            â”‚  â”‚
â”‚  â”‚  - fastapi               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  è®­ç»ƒè¿›ç¨‹                â”‚  â”‚
â”‚  â”‚  python rllib_train.py   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  åç«¯æœåŠ¡ (Port 8000)    â”‚  â”‚
â”‚  â”‚  uvicorn app:app         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å‰ç«¯æœåŠ¡ (Port 3000)    â”‚  â”‚
â”‚  â”‚  python -m http.server   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å•æœºç”Ÿäº§éƒ¨ç½²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç”Ÿäº§æœåŠ¡å™¨                     â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Docker Container                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  Ray Head                  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - è®­ç»ƒå¼•æ“               â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - GPUæ”¯æŒ                â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  FastAPI + Uvicorn         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - REST API               â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - WebSocket              â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  Nginx                     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - é™æ€æ–‡ä»¶æœåŠ¡           â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - åå‘ä»£ç†               â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ•°æ®å·                          â”‚  â”‚
â”‚  â”‚  - /data/models                  â”‚  â”‚
â”‚  â”‚  - /data/logs                    â”‚  â”‚
â”‚  â”‚  - /data/results                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 é›†ç¾¤éƒ¨ç½²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Rayé›†ç¾¤æ¶æ„                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Load Balancer â”‚
â”‚   (Nginx)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”
â”‚ API1 â”‚  â”‚ API2 â”‚  â† FastAPIå®ä¾‹ (å¤šå‰¯æœ¬)
â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜
    â”‚         â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ray Head Node   â”‚  â† è°ƒåº¦å™¨ + Dashboard
â”‚  - 16æ ¸ + 2GPU   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚        â”‚        â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”
â”‚Workerâ”‚  â”‚Workerâ”‚  â”‚Workerâ”‚  â”‚Workerâ”‚  â† WorkerèŠ‚ç‚¹
â”‚8æ ¸+1Gâ”‚  â”‚8æ ¸+1Gâ”‚  â”‚8æ ¸+1Gâ”‚  â”‚8æ ¸+1Gâ”‚
â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      å…±äº«å­˜å‚¨ (NFS/S3)               â”‚
â”‚  - æ¨¡å‹æ£€æŸ¥ç‚¹                        â”‚
â”‚  - è®­ç»ƒæ—¥å¿—                          â”‚
â”‚  - ç»“æœæ•°æ®                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç¬¬äº”éƒ¨åˆ†ï¼šå¼€å‘æŒ‡å—

### 5.1 ç¯å¢ƒæ­å»º

```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repository>
cd MARL-task

# 2. åˆ›å»ºCondaç¯å¢ƒ
conda create -n marl-task python=3.8
conda activate marl-task

# 3. å®‰è£…ä¾èµ–
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
pip install "ray[rllib]==2.50.1"
pip install gymnasium pandas numpy pyyaml matplotlib seaborn tensorboard
pip install fastapi uvicorn websockets

# 4. éªŒè¯å®‰è£…
python -c "import ray; import torch; print('Ray:', ray.__version__); print('CUDA:', torch.cuda.is_available())"
```

### 5.2 å¼€å‘å·¥ä½œæµ

```bash
# 1. æµ‹è¯•ç¯å¢ƒ
python rllib_env/test_env.py

# 2. æœ¬åœ°è®­ç»ƒæµ‹è¯•
python rllib_train.py --algo SAC --local --iterations 10

# 3. å¯åŠ¨åç«¯
cd backend
uvicorn app:app --reload --port 8000

# 4. å¯åŠ¨å‰ç«¯
cd frontend
python -m http.server 3000

# 5. è®¿é—®
open http://localhost:3000
```

### 5.3 æ·»åŠ æ–°ç®—æ³•

```python
# 1. åœ¨rllib_train.pyä¸­æ·»åŠ ç®—æ³•é…ç½®
from ray.rllib.algorithms.ddpg import DDPGConfig

def create_ddpg_config(env_config):
    config = DDPGConfig()
    config.environment(env="berth_allocation", env_config=env_config)
    # ... é…ç½®å‚æ•°
    return config

# 2. æ³¨å†Œåˆ°ç®—æ³•å­—å…¸
ALGORITHM_CONFIGS = {
    "SAC": create_sac_config,
    "PPO": create_ppo_config,
    "DDPG": create_ddpg_config,  # æ–°å¢
}
```

### 5.4 è‡ªå®šä¹‰ç½‘ç»œ

```python
# 1. å®šä¹‰ç½‘ç»œ
from ray.rllib.models.torch.torch_modelv2 import TorchModelV2
import torch.nn as nn

class MyCustomNetwork(TorchModelV2):
    def __init__(self, obs_space, action_space, num_outputs, model_config, name):
        super().__init__(obs_space, action_space, num_outputs, model_config, name)

        # å®šä¹‰ç½‘ç»œå±‚
        self.net = nn.Sequential(
            nn.Linear(17, 256),
            nn.ReLU(),
            nn.Linear(256, 256),
            nn.ReLU(),
        )

        self.policy_head = nn.Linear(256, num_outputs)
        self.value_head = nn.Linear(256, 1)

# 2. æ³¨å†Œç½‘ç»œ
from ray.rllib.models import ModelCatalog
ModelCatalog.register_custom_model("my_network", MyCustomNetwork)

# 3. ä½¿ç”¨ç½‘ç»œ
config.model = {
    "custom_model": "my_network",
    "custom_model_config": {},
}
```

### 5.5 æ‰©å±•APIç«¯ç‚¹

```python
# backend/api/custom.py
from fastapi import APIRouter

router = APIRouter()

@router.post("/custom/endpoint")
async def custom_endpoint(data: dict):
    # è‡ªå®šä¹‰é€»è¾‘
    result = process_data(data)
    return {"result": result}

# backend/app.py
from api import custom
app.include_router(custom.router, prefix="/api/custom")
```

---

## é™„å½•Aï¼šæŠ€æœ¯æ ˆ

| å±‚æ¬¡ | æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|------|
| **æ¡†æ¶** | Ray RLlib | 2.50.1 | å¼ºåŒ–å­¦ä¹ è®­ç»ƒ |
| **æ·±åº¦å­¦ä¹ ** | PyTorch | 2.0+ | ç¥ç»ç½‘ç»œ |
| **ç¯å¢ƒ** | Gymnasium | 0.28+ | ç¯å¢ƒæ ‡å‡† |
| **åç«¯** | FastAPI | latest | REST API |
| **å‰ç«¯** | HTML/JS | - | Web UI |
| **å¯è§†åŒ–** | TensorBoard | 2.12+ | è®­ç»ƒç›‘æ§ |
| **æ•°æ®** | NumPy/Pandas | latest | æ•°æ®å¤„ç† |
| **é…ç½®** | PyYAML | latest | é…ç½®ç®¡ç† |

---

## é™„å½•Bï¼šæ€§èƒ½æŒ‡æ ‡

| æ¨¡å— | æ€§èƒ½æŒ‡æ ‡ | ç›®æ ‡å€¼ |
|------|---------|--------|
| **ç¯å¢ƒ** | step()è€—æ—¶ | <5ms |
| **æ¨ç†** | å•æ¬¡æ¨ç† | <10ms |
| **API** | å“åº”æ—¶é—´ | <100ms |
| **è®­ç»ƒ** | ååé‡ | >10Kæ ·æœ¬/ç§’ |
| **å†…å­˜** | å³°å€¼å ç”¨ | <8GB (50èˆ¹) |

---

## é™„å½•Cï¼šå¸¸ç”¨å‘½ä»¤

```bash
# è®­ç»ƒ
python rllib_train.py --algo SAC --num-vessels 50 --iterations 1000

# å¯åŠ¨æœåŠ¡
uvicorn backend.app:app --host 0.0.0.0 --port 8000

# Rayé›†ç¾¤
ray start --head
ray status
ray stop

# ç›‘æ§
tensorboard --logdir=./ray_results
open http://localhost:8265  # Ray Dashboard
```

---

**æ–‡æ¡£ç»´æŠ¤**: Duan
**æœ€åæ›´æ–°**: 2025-10-28
**ç‰ˆæœ¬**: v2.0
